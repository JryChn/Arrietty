"use strict";cjce.registerTemplate("bm-p-voice",function(n,o){var t,s,l,r,c,a,i,e,d,m="https://voice.google.com",b=m+"/u/"+o.account.authuser+"/",p="https://www.google.com/voice/b/"+o.account.authuser+"/",u=cjBasics.uniqueId.generate(),j=cjBasics.urlParams.attach(b,{bm_cid:"voicewithwebapp",bm_iid:u,bm_cst:"1",hl:cjBasics.lang.current}),g="calls",v=g,_="#00897b",h=cjBasics.wrif.supported,f=!0,w={voicemail:{name:"__mdi:voicemail"},sms:{name:"__mdi:textsms"},missed:{name:"__mdi:call_missed",color:"#ea4335"},received:{name:"__mdi:call_received",color:"#34a853"},placed:{name:"__mdi:call_made",color:_}},C=["missed","received","voicemail","","","","","","","received","sms","sms"];function B(){t={calls:{iconName:"__mdi:call",label:cjBasics.lang.i18n("cj_i18n_01170","Calls"),testId:"sidenav-calls",newTabUrl:!0},messages:{iconName:"__mdi:message",label:cjBasics.lang.i18n("cj_i18n_01128","Messages"),testId:"sidenav-messages",newTabUrl:!0,external:!h},voicemail:{iconName:"__mdi:voicemail",label:cjBasics.lang.i18n("cj_i18n_01129","Voicemail"),testId:"sidenav-voicemail",newTabUrl:!0,external:!h,divider:!0},archive:{iconName:"__mdi:archive",label:cjBasics.lang.i18n("cj_i18n_00821","Archive"),testId:"sidenav-archive",newTabUrl:!0,external:!h},spam:{iconName:"__mdi:report",label:cjBasics.lang.i18n("cj_i18n_00306","Spam"),testId:"sidenav-spam",newTabUrl:!0,external:!h,divider:!0},credits:{iconName:"__mdi:account_balance_wallet",label:cjBasics.lang.i18n("cj_i18n_00398","Credits"),newTabUrl:!0,external:!h},settings:{iconName:"__mdi:settings",label:cjBasics.lang.i18n("cj_i18n_00298","Settings"),newTabUrl:!0,external:!h,testId:"settings-ogb-button"}}}function T(e){var a=cjce.createElement("cjmd-card",{withPadding:!0}),c=cjce.createElement("cjmd-title",{label:e.displayNumber});a.appendChild(c);var n=C[e.type]||"placed",i=w[n],t=cjce.createElement("cjmd-icon",i);t.classList.add("bm-p-voice-callicon"),a.appendChild(t);var s=document.createElement("p");s.textContent=e.displayStartDateTime,a.appendChild(s);var l=cjce.createElement("cjmd-secondarytext",{label:e.relativeStartTime});a.appendChild(l);var r=cjce.createElement("cjmd-button",{hairline:!0,color:_,label:cjBasics.lang.i18n("cj_i18n_00213","Call"),onClick:function(){!function(e){var a=e||{},c={authuser:o.account.authuser};void 0!==a.number?(c.hip=a.number,c.hpn=a.number):c.hip="";var n=cjBasics.urlParams.attach("https://plus.google.com/hangouts/_/",c);o.openTab(n)}({number:e.phoneNumber})}});return r.classList.add("bm-p-voice-callbutton"),a.appendChild(r),a}function x(){var i=cjce.createElement("cjmd-container",{scrollable:!0,shadow:"transparentOnScroll"});function e(){var e=cjce.createElement("cjmd-emptystate",{color:_,label:cjBasics.lang.i18n("cj_i18n_00394","No recent calls"),iconName:"__mdi:call"});i.appendChild(e)}return cjce.applyTemplate(i,"bm-loading",{state:!0}),cjBasics.ajax(p+"inbox/recent/all/?hl="+cjBasics.lang.current,{fetchAs:"xml"}).then(function(e){var a=e.querySelector("json").textContent.replace("<![CDATA[","").replace("]]>","");return JSON.parse(a).messages}).then(function(n){Object.keys(n).length<1?e():Object.keys(n).forEach(function(e){var a,c=n[e];c.isTrash||c.isSpam||(a=T(n[e]),i.appendChild(a))})},e).then(function(){cjce.applyTemplate(i,"bm-loading",{state:!1})}),i}function E(){var e=cjce.createElement("bm-ogb",{drawer:{color:_},serviceIcon:"voice",serviceLabel:cjBasics.lang.i18n("cj_i18n_00443","Voice"),pageLabel:h?cjBasics.lang.i18n("cj_i18n_00291","Home"):cjBasics.lang.i18n("cj_i18n_01170","Calls"),searchbox:{color:_,onSubmit:y,submitInNewTab:!0},bmApis:o,onNewTab:function(){h?k():o.openTab(b)}});n.appendChild(e);var a=e.cjceDrawerEl;o.setOnPageDisplayHandler(e.cjceSearchboxEl.select),s=cjce.createElement("bm-navlist",{isSelector:!0,items:t,selectedId:g,onChange:N,onNewTab:function(e){var a="credits"===e?b+"settings#payments":b+e;o.openTab(a)}}),a.appendChild(s);var c=e.cjceSearchboxEl;return o.setOnPageDisplayHandler(c.select),cjBasics.ajax(p+"request/user?hl="+cjBasics.lang.current,{fetchAs:"json"}).then(function(e){var a=e&&e.formattedCredit;if(a)return a;throw Error()},function(){throw Error()}).then(function(e){var a;e&&1<e.length&&((a=s.cjceGetItemElement("credits")).classList.add("bm-p-voice-credits"),!h&&o.darkMode&&a.classList.add("bm-p-voice-credits--dark"),a.dataset.creditcount=e)},function(){console.debug("voice - couldn\t receive credits")}),e}function S(e){var a,c,n=e.bm_method,i=e.bm_value;"voicewithwebappLoaded"===n?f=!1:"voicewithwebappPageTitle"===n?r.cjceSetPageLabel(i):"voicewithwebappUpdateView"===n&&i&&(a="back"===i||"signup"===i,r.hidden=!a,v=i,a||(g=i,s.cjceSelectedId=i,c=t[i].label,l.cjceSetPageLabel(c)))}function N(e){var a='[gv-test-id="'+t[e].testId+'"]';"credits"===e?(s.cjceSelectedId="settings",g="settings",a='gv-nav-item[ng-if*="obs_isCreditVisible"], gv-nav-item[ng-click*="onCreditClick"]'):"markallasread"===e?(s.cjceSelectedId=g,a='gv-nav-item[ng-click*="onMarkAllAsRead"]'):g=e,c.cjceSendFrameCommand({method:"bmCstClickDomElement",value:a},m)}function y(e){var a=cjBasics.urlParams.attach(b+"search",{from:"[]",q:JSON.stringify(e.split(" "))});o.openTab(a)}function k(){c.cjceGetCleanUrl(m).then(function(e){var a=e||b;o.openTab(a)})}function I(e){return f=!1,function(){n.textContent="";var e=cjce.createElement("bm-fulldialog",{bmApis:o,onNewTab:function(){o.openTab(b)},lockup:{label:cjBasics.lang.i18n("cj_i18n_00443","Voice")},iconName:"voice",message:cjBasics.lang.i18n("cj_i18n_01175","You are not signed up to Voice yet"),actionLabel:cjBasics.lang.i18n("cj_i18n_00337","Sign up"),action:function(){o.openTab(b+"signup")}});n.appendChild(e)}(),a&&a.removeListener(),i&&i.removeListener(),{cancel:!0}}B(),l=E(),n.appendChild(l),i=cjBasics.webRequest.addListener("onBeforeRedirect",I,{types:["xmlhttprequest"],urls:[p+"*"]}),h&&(a=cjBasics.webRequest.addListener("onBeforeRequest",I,{types:["sub_frame"],urls:[b+"about"]},["blocking"])),h?(h=!1,(d=cjce.createElement("bm-ogb",{displayBack:!0,floating:!0,serviceLabel:cjBasics.lang.i18n("cj_i18n_00443","Voice"),pageLabel:cjBasics.lang.i18n("cj_i18n_01174","Loading")+"...",searchbox:{color:_,onSubmit:y,submitInNewTab:!0},bmApis:o,onNewTab:k,onBack:function(){N(g),d.hidden=!0,"signup"===v&&(c.src="about:blank",setTimeout(function(){c.src=j}))}})).hidden=!0,r=d,n.appendChild(r),cjBasics.webRequest.handleIframeHeaders([m+"/*bm_iid="+u+"*"],{useMobileUserAgent:!0}),c=cjce.createElement("bm-iframe",{src:j,solid:"#fff",shadow:!0,onMessage:S}),n.appendChild(c),setTimeout(function(){var e;f&&(h=!1,B(),n.textContent="",l=E(),n.appendChild(l),e=x(),n.appendChild(e))},3e3)):(e=x(),n.appendChild(e))});