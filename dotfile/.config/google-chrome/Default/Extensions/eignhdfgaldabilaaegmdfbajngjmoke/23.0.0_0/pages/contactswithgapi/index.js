"use strict";cjce.registerTemplate("bm-p-contactswithgapi",function(u,p){var m,o,h,r,f,a,s="https://contacts.google.com/"+p.wizPath,c="https://people.googleapis.com/v1/",t="https://www.google.com/m8/feeds/",i=["https://www.googleapis.com/auth/contacts.readonly"],l=40,d=Math.ceil(l*window.devicePixelRatio),b=s,_="home",g=null,j=0,v=25,y=["contactGroups/coworkers","contactGroups/family","contactGroups/friends"],C=!1,N=browserStorage.sync.getItem("bm_pref__contacts__lastname").then(function(e){C=Boolean(e)}),w="connections(resourceName,names(displayName,displayNameLastFirst),photos/url,memberships/contactGroupMembership/contactGroupId),nextPageToken",e=null,E=!1,A=function(){if(cjgApis.info.getIsConsumerGmail(p.account))return Promise.resolve(!1);return cjgApis.cache.getItem(p.account,"bm_pref__contacts__directory").then(function(e){return"boolean"==typeof e?e:O().then(function(){return!0},function(){return!1}).then(function(e){return cjgApis.cache.setItem(p.account,"bm_pref__contacts__directory",e),e})})}().then(function(e){e&&(E=!0,w=w.replace("resourceName,","resourceName,metadata/sources(type,id),"))}),L=!1,T={};function S(e,a){j=0,f.cjceSetLoading(!0),_=e,g=a,L&&U()}function n(){Promise.all([cjgApis.cache.getItem(p.account,"bm_cache_v30__contacts__library"),N]).then(function(e){L||(m=e[0])&&(L=!0,U())}),Promise.all([A,N]).then(function(e){var a,t,n,c=(n=a||[],B("people/me/connections",{pageToken:t,pageSize:"2000",personFields:"memberships,metadata,names,photos",fields:w,sortOrder:C?"LAST_NAME_ASCENDING":"FIRST_NAME_ASCENDING"}).then(function(e){return Array.isArray(e.connections)&&(e.connections.forEach(function(e){var a=P(e);a&&n.push(a)}),e.nextPageToken),n}));return E?Promise.all([O().then(k),c]).then(function(e){var a=e[0],t=e[1],n=a.map(function(e){return e.id});return t.forEach(function(e){-1===n.indexOf(e.id)&&a.push(e)}),R(a),a}):c}).then(function(e){L=!0,m&&JSON.stringify(m).length===JSON.stringify(e).length||(cjgApis.cache.setItem(p.account,"bm_cache_v30__contacts__library",e),m=e,U())})}function B(a,t){var e=t||{};e.prettyPrint="false";var n=cjBasics.urlParams.attach(c+a,e);return cjgApis.request(n,{fetchAs:"json"},{account:p.account,requiredScopes:i}).catch(function(){return new Promise(function(e){setTimeout(function(){B(a,t).then(e)},4e3)})})}function G(){return cjce.createElement("gmd-fab",{label:cjBasics.lang.i18n("cj_i18n_01285","Create contact"),onClick:function(){p.openTab(s+"new")}})}function I(e,a){return"string"!=typeof e||e.length<5?"/images/avatar.svg":(e.startsWith("http://")&&(e=e.replace("http://","https://")),e.startsWith("https://www.google.com/s2/")&&(e=e.replace("www","profiles")),e+"?sz="+(a||"40"))}function P(e){var a=function(e){var a=e.resourceName;if(!E||!a.startsWith("people/c"))return a;var t=e.metadata&&e.metadata.sources;if(!Array.isArray(t))return a;for(var n=0;n<t.length;n++)if("DOMAIN_PROFILE"===t[n].type)return"people/"+t[n].id;return a}(e),t=e&&e.names&&e.names[0]||T[a];if(t){var n=t.displayName||"",c=t.displayNameLastFirst||n;if(n)return{id:a,displayName:n,displayNameLastFirst:c,sortValue:n.toLowerCase(),sortValueLastFirst:c.toLowerCase(),photo:e.photos?e.photos[0].url:null,memberships:Array.isArray(e.memberships)?e.memberships.map(function(e){return e.contactGroupMembership?e.contactGroupMembership.contactGroupId:"GSUITE_DIRECTORY_GROUP"}):[]}}}function k(e){for(var t=[],a=[],n=0;n<e.length;n+=50){var c=B("people:batchGet",{resourceNames:e.splice(0,50),fields:"responses(requestedResourceName,person(names(displayName,displayNameLastFirst),photos/url,memberships/contactGroupMembership/contactGroupId))",personFields:"names,photos,memberships"}).then(function(e){e.responses.forEach(function(e){e.person.resourceName=e.requestedResourceName;var a=P(e.person);a&&t.push(a)})});a.push(c)}return Promise.all(a).then(function(){return t})}function O(){return e=e||cjgApis.info.getUserDomain(p.account).then(function(e){var a=cjBasics.urlParams.attach(t+"gal/"+(e||"default")+"/full",{alt:"json","max-results":"50000"});return cjgApis.request(a,{fetchAs:"json",headers:{"GData-Version":"1.0"}},{account:p.account,requiredScopes:i})}).then(function(e){var d=[],a=e&&e.feed&&e.feed.entry;return Array.isArray(a)&&a.forEach(function(e){var a,t,n,c,i,o,r,s,l=function(e){var a=e.id&&e.id.$t&&e.id.$t.split("full/P.")[1];if(!a)return null;for(var t=cjBasics.numbers.hex2dec(a);t.length<20;)t="0"+t;return t.length<21&&(t="1"+t),t}(e);l&&(t=a="people/"+l,(s=e.gd$name)&&(n=s.gd$fullName&&s.gd$fullName.$t,c=s.gd$givenName&&s.gd$givenName.$t,i=s.gd$familyName&&s.gd$familyName.$t,o=n||c||i,r=i&&c?i+", "+c:null,T[t]={displayName:o,displayNameLastFirst:r}),d.push(a))}),d})}function x(a){return m.filter(function(e){return-1!==e.memberships.indexOf(a)})}function F(e,a){var t=document.createDocumentFragment();a.forEach(function(e){var a=function(e){var a=C&&e.displayNameLastFirst||e.displayName,t={withShell:!0,size:l};e.photo?(t.url=I(e.photo,d),t.color="#fff"):t.symbol=a[0]||" ";var n=cjce.createElement("cjmd-item",{icon:t,label:a});n.classList.add("bm-p-contactswithgapi-listitem"),n.cjceContactsData=e;var c=cjce.createElement("cjmd-iconbutton",{label:cjBasics.lang.i18n("cj_i18n_06290","Edit contact"),iconName:"__mdi:edit",onClick:function(){M(e.id,!0)}});c.classList.add("bm-p-contactswithgapi-listitem__tool"),n.appendChild(c);var i=cjce.createElement("cjmd-iconbutton",{label:cjBasics.lang.i18n("cj_i18n_01545","Open in a new tab"),iconName:"__mdi:open_in_new",onClick:function(){M(e.id)}});return i.classList.add("bm-p-contactswithgapi-listitem__tool"),n.appendChild(i),n}(e);t.appendChild(a)}),e.appendChild(t)}function U(){f.cjceSetLoading(!0);var n,e,a,t,c,i,o,r,s,l=null,d=cjce.createElement("cjmd-container",{scrollable:!0,shadow:"thinOnScroll",onScrollBottom:function(){l&&l()}});"home"===_?(0<(e=x("starred")).length&&(a=cjce.createElement("cjmd-subheader",{color:!0,label:cjBasics.lang.i18n("cj_i18n_00004","Starred")}),d.appendChild(a),F(t=cjce.createElement("cjmd-list"),e),d.appendChild(t),c=cjce.createElement("cjmd-subheader",{color:!0,label:cjBasics.lang.i18n("cj_i18n_00314","Contacts")}),d.appendChild(c)),n=x("myContacts")):"search"===_?(i=g,n=m.filter(function(e){return-1!==JSON.stringify(e).indexOf(i)})):"directory"===_?n=x("GSUITE_DIRECTORY_GROUP"):"label"===_&&(n=x(g)),0<n.length?(o=cjce.createElement("cjmd-list"),function e(a){l=null,j+=v;var t=n.splice(0,a?j:v);F(o,t),n.length&&(l=e)}(!0),d.appendChild(o)):(s=_,r=cjce.createElement("cjmd-emptystate",{color:!0,label:cjBasics.lang.i18n("cj_i18n_01275","No contacts found"),subLabel:"search"===s?cjBasics.lang.i18n("cj_i18n_00116","Try a synonym or more general keyword"):null,iconName:"search"===s?"__mdi:search":"__mdi:contacts_product"}),d.appendChild(r)),h.textContent="",h.appendChild(d),f.cjceSetLoading(!1)}function D(e,a){var t=a.resourceName.replace("contactGroups/",""),n=a.formattedName,c=n,i=a.memberCount;0<i&&(c+=" ("+i+")"),e.push({id:t,iconName:"__mdi:label",label:c,navigatorLabel:n,newTabUrl:s+"label/"+t})}function R(e){var t=C?"sortValueLastFirst":"sortValue";e.sort(function(e,a){return e[t]<a[t]?-1:1})}function q(){cjce.applyTemplate(r,"bm-loading");var n=[{id:"home",label:cjBasics.lang.i18n("cj_i18n_00314","Contacts"),navigatorLabel:cjBasics.lang.i18n("cj_i18n_00291","Home"),iconName:"__mdi:person",newTabUrl:s,divider:!0}],c=[{label:cjBasics.lang.i18n("cj_i18n_01276","Frequently contacted"),iconName:"__mdi:history",newTabUrl:s+"frequent",external:!0},{label:cjBasics.lang.i18n("cj_i18n_01277","Duplicates"),iconName:"__mdi:assistant",newTabUrl:s+"merge",external:!0},{label:cjBasics.lang.i18n("cj_i18n_01278","Other contacts"),iconName:"__mdi:archive",newTabUrl:s+"other",external:!0,divider:!0}],i=document.createElement("div");r.appendChild(i);var e=B("contactGroups",{pageSize:"500",fields:"contactGroups(resourceName,groupType,formattedName,memberCount)"});Promise.all([e,N,A]).then(function(e){var t=[];E&&(n[0].divider=!1,n.push({id:"directory",label:cjBasics.lang.i18n("cj_i18n_01279","Directory"),iconName:"__mdi:business",newTabUrl:s+"directory",divider:!0})),e[0].contactGroups.forEach(function(e){var a;"USER_CONTACT_GROUP"===e.groupType?D(t,e):"contactGroups/myContacts"===e.resourceName?0<(a=e.memberCount)&&(n[0].label+=" ("+a+")"):-1!==y.indexOf(e.resourceName)&&0<e.memberCount&&D(t,e)}),0<t.length&&(n.push({header:!0,label:cjBasics.lang.i18n("cj_i18n_01280","Labels")}),t.sort(function(e,a){return e.label.toLowerCase()<a.label.toLowerCase()?-1:1}),t[t.length-1].divider=!0,n=n.concat(t)),n=n.concat(c),o=cjce.createElement("bm-navlist",{compact:!0,isSelector:!0,selectedId:"home",items:n,onChange:function(e,a){b=a.newTabUrl||s,"home"===e||"directory"===e?S(e):S("label",e),f.cjceSetPageLabel(a.navigatorLabel||a.label)},onNewTab:function(e,a){p.openTab(a.newTabUrl)}}),i.appendChild(o);var a=cjce.createElement("bm-drawerdropdown",{iconName:"__mdi:cj_sort_by_alpha",label:cjBasics.lang.i18n("cj_i18n_01281","Sort"),selectedId:C?"last":"first",items:[{value:"last",label:cjBasics.lang.i18n("cj_i18n_01282","Sort by last name")},{value:"first",label:cjBasics.lang.i18n("cj_i18n_01283","Sort by first name")}],onChange:function(){var e;e="last"===a.cjceSelectedId,C=e,browserStorage.sync.setItem("bm_pref__contacts__lastname",C),L&&(R(m),U())}});r.appendChild(a),r.cjceSetLoading(!1)})}function $(e){var a=cjce.createElement("cjmd-item");e.onClick?a.addEventListener("click",function(){e.onClick()}):a.classList.add("no-action");var t=cjce.createElement("cjmd-icon",{name:e.iconName});a.appendChild(t);var n=document.createElement("div");n.className="cjmd-item__body",a.appendChild(n);var c,i=document.createElement("div");return i.className="cjmd-item__header",i.textContent=e.value,n.appendChild(i),e.subLabel&&(c=cjce.createElement("cjmd-secondarytext",{label:e.subLabel}),n.appendChild(c)),a}function M(e,a){var t=s+e.replace("people/","person/");a&&(t+="?edit=true"),p.openTab(t)}function V(e){var a=encodeURIComponent(e),t=s+"search/"+a;p.openTab(t)}function z(){var e=o.cjceSelectedId;"home"===e||"directory"===e?S(e):S("label",e)}!function(){f=cjce.createElement("bm-ogb",{loading:!0,drawer:!0,serviceIcon:"contacts",serviceLabel:cjBasics.lang.i18n("cj_i18n_00314","Contacts"),pageLabel:cjBasics.lang.i18n("cj_i18n_00291","Home"),searchbox:{color:!0,onClear:z,onInput:function(e){e?S("search",e):z()},onSubmit:function(){h.querySelector(".cjmd-item").click()},onMetaSubmit:V},bmApis:p,onNewTab:function(){"search"===_?V(g):p.openTab(b)}}),u.appendChild(f),r=f.cjceDrawerEl,a=f.cjceSearchboxEl;var e=G();u.appendChild(e),p.setOnPageDisplayHandler(a.select),(h=cjce.createElement("cjmd-container")).addEventListener("click",function(e){var a=e.target.cjceContactsData;a&&function(e){var a=cjce.createElement("cjmd-container",{solid:!0});a.classList.add("bm-p-contactswithgapi-details");var t=cjce.createElement("bm-ogb",{floating:!0,displayBack:!0,onBack:function(){a.remove()},bmApis:p,onNewTab:function(){M(e.id)}});a.appendChild(t);var n=cjce.createElement("cjmd-iconbutton",{label:cjBasics.lang.i18n("cj_i18n_06290","Edit contact"),iconName:"__mdi:edit",onClick:function(){M(e.id,!0)}});t.cjceAppendChild(n);var c=document.createElement("div");c.className="bm-p-contactswithgapi-details__top",a.appendChild(c);var i=C&&e.displayNameLastFirst||e.displayName,o=Math.ceil(80*window.devicePixelRatio),r={withShell:!0,size:80};e.photo?(r.url=I(e.photo,o),r.color="#b3b3b3"):r.symbol=i[0]||" ";var s=cjce.createElement("cjmd-icon",r);s.classList.add("bm-p-contactswithgapi-details__photo"),c.appendChild(s);var l=cjce.createElement("cjmd-title",{label:i});l.classList.add("bm-p-contactswithgapi-details__name"),c.appendChild(l);var d=cjce.createElement("cjmd-container",{scrollable:!0,shadow:"thickOnScroll"});a.appendChild(d);var m=cjce.createElement("cjmd-list");d.appendChild(m),B(e.id,{fields:"addresses,birthdays,emailAddresses,phoneNumbers"}).then(function(e){var a,t=document.createDocumentFragment();Array.isArray(e.emailAddresses)&&0<e.emailAddresses.length&&e.emailAddresses.forEach(function(e){var a=$({iconName:"__mdi:email",value:e.value,subLabel:e.formattedType,onClick:function(){p.openTab("mailto:"+e.value)}});t.appendChild(a)}),Array.isArray(e.phoneNumbers)&&0<e.phoneNumbers.length&&e.phoneNumbers.forEach(function(e){var a=$({iconName:"__mdi:call",value:e.value,subLabel:e.formattedType,onClick:function(){p.openTab(cjBasics.urlParams.attach("https://hangouts.google.com/",{authuser:p.account.authuser,pn:e.canonicalForm,action:"chat"}))}});t.appendChild(a)}),Array.isArray(e.addresses)&&0<e.addresses.length&&e.addresses.forEach(function(e){var a=$({iconName:"__mdi:place",value:e.formattedValue,subLabel:e.formattedType,onClick:function(){p.openTab(cjBasics.urlParams.attach("https://maps.google.com/",{authuser:"0"===p.account.authuser?null:p.account.authuser,q:e.formattedValue}))}});t.appendChild(a)}),Array.isArray(e.birthdays)&&0<e.birthdays.length&&e.birthdays.forEach(function(e){var a=$({iconName:"__mdi:cake",value:e.text});t.appendChild(a)}),0===t.children.length&&((a=document.createElement("div")).className="bm-p-contactswithgapi-noinfo",a.textContent=cjBasics.lang.i18n("cj_i18n_01284","No more contact info found"),t.appendChild(a)),m.appendChild(t),f.cjceSetLoading(!1)}),u.appendChild(a)}(a)}),u.appendChild(h),n(),q(),cjgApis.auth.requireToken(p.account,i).catch(function(e){var a=cjce.createElement("bm-fulldialog",{bmApis:p,onNewTab:function(){p.openTab(b)},lockup:{label:cjBasics.lang.i18n("cj_i18n_00314","Contacts")},iconName:"contacts",message:cjBasics.lang.i18n("cj_i18n_01286","Before you can use this page, you need to give access to load your Google Contacts"),actionLabel:cjBasics.lang.i18n("cj_i18n_01916","Continue with Google"),actionG:!0,action:function(){cjgApis.auth.requestPermissions(p.account,e.cjg_missing_scopes)}}),t=G();a.appendChild(t),u.appendChild(a)})}()});